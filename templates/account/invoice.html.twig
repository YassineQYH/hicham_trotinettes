<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Facture {{ order.reference }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 5mm;
        }
        .facture {
            width: 150mm;
            padding: 5mm;
            border: 1px solid #000;
            box-sizing: border-box;
        }
        .facture div { margin-bottom: 8px; }
        h1 { font-size: 14px; margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 5px; }
        th, td { border: 1px solid #000; padding: 5px; text-align: left; }
        th:nth-child(4), td:nth-child(4),
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7) { min-width: 60px; white-space: nowrap; }
        .totals td { border: none; padding: 5px; }
        .footer { font-size: 10px; margin-top: 5px; color: gray; }
    </style>
</head>
<body>
<div class="facture">
    <h1>Facture - {{ order.reference }}</h1>

    <div>
        <strong>Vendeur :</strong> Hich-Trott<br>
        <strong>Adresse :</strong> 123 Rue Exemple, 75000 Paris<br>
        <strong>Email :</strong> contact@hich-trott.fr
    </div>

    <div style="margin-top:5px;">
        <strong>Client :</strong> {{ order.user.firstName }} {{ order.user.lastName }}<br>
        <strong>Adresse :</strong> {{ order.delivery|raw }}
    </div>

    <hr>

    <table>
        <thead>
            <tr>
                <th>Produit</th>
                <th>Quantité</th>
                <th>Poids</th>
                <th>Prix unitaire HT</th>
                <th>Total HT</th>
                <th>TVA</th>
                <th>Total TTC</th>
            </tr>
        </thead>
        <tbody>
            {% set totalHT = 0 %}
            {% set totalTVA = 0 %}
            {% for item in order.orderDetails %}
                {% set totalItemHT = item.price * item.quantity %}
                {% set tvaItem = totalItemHT * (item.tva / 100) %}
                {% set totalItemTTC = totalItemHT + tvaItem %}
                <tr>
                    <td>{{ item.product }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.weight * item.quantity }} kg</td>
                    <td>{{ item.price|number_format(2, ',', '.') }} €</td>
                    <td>{{ totalItemHT|number_format(2, ',', '.') }} €</td>
                    <td>{{ tvaItem|number_format(2, ',', '.') }} €</td>
                    <td>{{ totalItemTTC|number_format(2, ',', '.') }} €</td>
                </tr>
                {% set totalHT = totalHT + totalItemHT %}
                {% set totalTVA = totalTVA + tvaItem %}
            {% endfor %}
        </tbody>
    </table>

    {% set totalProduitsTTC = totalHT + totalTVA %}
    {% set promo = order.promoReduction ?? 0 %}
    {% set totalCommande = totalProduitsTTC - promo + order.carrierPrice %}

    <table style="width:100%; border-collapse:collapse; font-size:11px; margin-top:5px;">
        <tbody>
            <tr>
                <td>Sous-total HT :</td>
                <td>{{ totalHT|number_format(2, ',', '.') }} €</td>
            </tr>
            <tr>
                <td>TVA :</td>
                <td>{{ totalTVA|number_format(2, ',', '.') }} €</td>
            </tr>
            <tr>
                <td><strong>Total TTC produits :</strong></td>
                <td>{{ totalProduitsTTC|number_format(2, ',', '.') }} €</td>
            </tr>
            {% if promo > 0 %}
            <tr>
                <td><strong>Réduction ({{ order.promoTitre ?? order.promoCode }}):</strong></td>
                <td>-{{ promo|number_format(2, ',', '.') }} €</td>
            </tr>
            {% endif %}
            <tr>
                <td>Frais de livraison :</td>
                <td>{{ order.carrierPrice|number_format(2, ',', '.') }} €</td>
            </tr>
            <tr>
                <td><strong>Total TTC :</strong></td>
                <td><strong>{{ totalCommande|number_format(2, ',', '.') }} €</strong></td>
            </tr>
        </tbody>
    </table>

    <div class="footer">
        Merci pour votre commande !<br>
        Hich-Trott - Tous droits réservés.
    </div>
</div>
</body>
</html>
